<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>إنشاء اتفاقية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">



  <!-- ✅ Header and sidebar -->
  <link rel="stylesheet" href="../background-header/Header-style.css" />
  <script src="../background-header/load-header.js" defer></script>
  <link rel="stylesheet" href="sidebar-style.css" />
  <script src="load-sidebar.js" defer></script>



  <style>
  .company-switcher {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
  }

  .company-btn {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    border-radius: 8px;
    box-shadow: none;
    transition: all 0.3s ease-in-out;
  }

  .active-btn {
    box-shadow: 0 0 10px 3px rgba(0,0,0,0.3);
  }

  .mamzar-bg {
    background-color: #dff5d2 !important;
  }

  .tradix-bg {
    background-color: #d2e8f5 !important;
  }


    :root {
      --primary: #1e3a8a;
      --secondary: #0f172a;
      --accent: #22d3ee;
      --danger: #ef4444;
      --text: #f8fafc;
      --glass: rgba(255, 255, 255, 0.05);
    }

    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e3a8a, #0f172a);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      color: var(--text);
      display: flex;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .main {
      flex: 1;
      padding: 30px;
      margin-top: 80px;
      margin-right: 250px;
    }

    .glass-card {
      background: var(--glass);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 18px;
      padding: 35px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(18px);
      transition: 0.3s;
    }

    h2, h3 {
      color: #ffffff;
      margin-bottom: 25px;
      text-shadow: 1px 1px 3px #000;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 18px;
      color: #dbeafe;
    }

    input, select, textarea {
      width: 98%;
      padding: 14px;
      border: none;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.07);
      color: #e2e3f0;
      margin-top: 6px;
      backdrop-filter: blur(6px);
      box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.1);
      transition: 0.3s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 0 2px var(--accent);
    }
  /* حقل تاريخ الاتفاقية */
  #agreement-date {
    width: 150px;
    height: 15px;
    font-size: 16px;
  }
    /* حقل تاريخ البداية */
  #start-date {
    width: 150px;
    height: 15px;
    font-size: 16px;
  }

  /* حقل تاريخ النهاية */
  #end-date {
    width: 150px;
    height: 15px;
    font-size: 16px;
  }
 /* حقل Credit Term */
  #credit-term {
    width: 150px;
    height: 45px;
    font-size: 16px;
  }
  /* البند الإضافي عربي */
  #extra-ar {
    width: 450px;
    height: 200px;
  }

  /* البند الإضافي إنجليزي */
  #extra-en {
    width: 450px;
    height: 200px;
  }

    /* جدول البنود: حقل وصف الخدمة */

.item-desc {
  width: 300px;
  height: 20px;
  border-radius: 10px;
  padding: 8px;
}
  /* جدول البنود: حقل وحدة القياس */

.item-uom {
  width: 70px;
  height: 20px;
  border-radius: 10px;
  padding: 8px;
}
  /* جدول البنود: حقل السعر */

.item-price {
  width: 90px;
  height: 20px;
  border-radius: 10px;
  padding: 8px;
}
  /* جدول البنود: حقل الملاحظات */

.item-note {
  width: 200px;
  height: 30px;
  border-radius: 10px;
  padding: 8px;
}

/* ✅ تنسيق عام لكل الـ Dropdowns */
select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;

  background-color: #24335A; /* لون خلفية القائمة */
  color: #ffffff;
  padding: 12px 16px;
  border: 2px solid #00cfff;
  border-radius: 12px;
  font-size: 16px;
  font-weight: bold;
  width: 100%;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  transition: 0.3s ease-in-out;
  cursor: pointer;
  position: relative;
  z-index: 2;
}

/* ✅ تغيير السهم باستخدام خلفية SVG */
select:after {
  content: "▼";
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}

/* ✅ عند الفوكس */
select:focus {
  outline: none;
  border-color: #66e0ff;
  box-shadow: 0 0 10px #00cfff;
}

/* ✅ تخصيص الـ option داخل القائمة */
select option {
  background-color: #192d45;
  color: #ffffff;
  padding: 10px;
  border-bottom: 1px solid #333;
  font-weight: 500;
}

/* ✅ تخصيص شريط التمرير للقائمة */
select::-webkit-scrollbar {
  width: 8px;
}

select::-webkit-scrollbar-thumb {
  background: #00cfff;
  border-radius: 10px;
}

select::-webkit-scrollbar-track {
  background: #1a1a2e;
}

  /* جدول البنود: زر الحذف */

.delete-btn {
  background: linear-gradient(145deg, #1e1e2f, #232342);
  color: red;
  font-size: 20px;
  font-weight: bold;
  text-align: center;
  border: none;
  border-radius: 12px;
  width: 40px;
  height: 40px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 8px #f4a3a366;
  transition: transform 0.2s, box-shadow 0.2s;
}

.delete-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 10px #fcf9f999;
}

.delete-btn:hover {
  background-color: #e60000;
}

    button {
      padding: 14px 28px;
      border: none;
      border-radius: 16px;
      background: linear-gradient(135deg, #1e3a8a, #2563eb);
      color: white;
      font-size: 16px;
      font-weight: bold;
      margin-top: 25px;
      cursor: pointer;
      transition: 0.3s ease;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
    }

    button:hover {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
    }

    .save-success {
      background: linear-gradient(135deg, #059669, #10b981) !important;
    }

    .two-cols {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .two-cols > div {
      flex: 1;
    }

    table {
      width: 100%;
      margin-top: 18px;
      border-collapse: collapse;
      border-radius: 12px;
      overflow: hidden;
    }

    th, td {
      padding: 14px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
      background-color: rgba(255, 255, 255, 0.03);
      color: #e2e8f0;
    }

    th {
      background-color: var(--primary);
      color: white;
    }

    .row-actions button {
      background-color: var(--danger);
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }

    .download-btn {
      display: inline-flex;
      align-items: center;
      margin: 10px;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: bold;
      color: white;
      border-radius: 12px;
      text-decoration: none;
      gap: 8px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }

    .word-btn {
      background-color: #2b579a;
    }

    .word-btn:hover {
      background-color: #1e3a8a;
    }

    .pdf-btn {
      background-color: #b91c1c;
    }

    .pdf-btn:hover {
      background-color: #7f1d1d;
    }

    #download-section {
      text-align: center;
      margin-top: 30px;
      display: none;
    }

    #client-info {
      margin-top: 12px;
      font-size: 14px;
      color: #cbd5e1;
    }
    

    /* حقل مكان تقديم الخدمة  */
    .service-place-row {
  display: flex;
  justify-content: space-between; /* توزع الحقول */
  gap: 30px; /* المسافة بين الحقول */
  margin-bottom: 25px; /* المسافة تحت الصف */
}

.service-place-box {
  flex: 1; /* كل واحد ياخد نصف العرض */
  display: flex;
  flex-direction: column;
}

.service-place-box label {
  font-weight: bold;
  margin-bottom: 5px;
  text-align: right;
  color: #ffffffcc;
}

.service-place-box textarea {
  width: 95%;
  height: 70px;
  padding: 12px;
  font-size: 16px;
  background: rgba(255, 255, 255, 0.07);
  border-radius: 15px;
}
/* ✅ تقليل المسافات الرأسية بين الحقول */
label {
  margin-top: 5px !important;  /* بدل 18px */
  margin-bottom: 3px !important;
}

input, select, textarea {
  margin-bottom: 3px !important;  /* تقليل المسافة بعد الحقل */
}
/* لعرض العنوان والحقل في سطر واحد */
.form-inline-group {
  display: flex;
  align-items: center;
  gap: 10px; /* مسافة بين العنوان والحقل */
  margin-bottom: 15px; /* مسافة بين الصفوف */
}

/* تنسيق إضافي لضبط حجم الحقل */
.form-inline-group input[type="date"] {
  width: 250px;
}

h2 {
  margin-bottom: 0px; /* تقليل المسافة تحت عنوان جدول الاسعار */
}

#items-table {
  margin-top: 0; /* إزالة أي مسافة علوية لجدول الاسعار */
}

.payment-duration-row {
  display: flex;
  align-items: center;
  gap: 40px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

/* شروط الدفع */
.credit-term-group {
  display: flex;
  flex-direction: column;
  min-width: 180px;
}

/* المدة */
.duration-inline-group {
  display: flex;
  flex-direction: column;
}

.duration-inline-inputs {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 5px;
}

.duration-inline-inputs label {
  margin: 0 5px;
}

/* ✨ تفعيل الزر الحالي */
.company-btn.active-btn {
  box-shadow: 0 0 12px 4px rgba(255, 255, 255, 0.6);
  transform: scale(1.05);
}

/* ✨ ألوان خلفيات الصفحات */
body.tradix-bg {
  background: linear-gradient(135deg, #0f172a, #1e3a8a, #0f172a);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
}

body.mamzar-bg {
  background: linear-gradient(135deg, #0f3d1e, #215d3a, #0f3d1e);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
}

/* تصميم عام لزراير اختيار الشركة */

  /* تجاوز التصميم العام للأزرار داخل الزرارين فقط */
  #tradixBtn {
    background: hsl(214, 65%, 25%) !important;
    color: white !important;
  }

  #mamzarBtn {
    background: oklab(53.205999999999996% -0.14215 0.10958) !important;
    color: white !important;
  }

  .company-btn.active-btn {
    box-shadow: 0 0 12px 4px rgba(255, 255, 255, 0.6);
    transform: scale(1.05);
  }

  </style>
</head>
<body>


  
  <div id="header"></div>
  <div id="sidebar-container"></div>

  <div class="main">
    <div class="glass-card">
    <h2 style="text-align: center;">📝 Service Agreement Creation</h2>


<div id="companySelector" style="display: flex; justify-content: center; gap: 25px; margin-bottom: 20px;">
  <button id="mamzarBtn" class="company-btn">Mamzar Est</button>
  <button id="tradixBtn" class="company-btn active-btn">Tradix Co</button>
</div>

<div style="text-align: left;"> 
  <label for="client">: Customer</label> 
  <select id="client" onchange="fillClientInfo()" style="padding: 6px; border-radius: 5px;">
    <option value="">-- اختر عميل --</option>
  </select>
</div>
<div id="client-info" style="margin-top: 10px; font-weight: bold;"></div>
      
</div>

      <div id="client-info"></div>

    <div class="form-inline-group" style="justify-content: left;">
            <input type="date" id="agreement-date" name="agreement-date">

      <label for="agreement-date">:Agreement Date</label>
    </div>

<h2 style="text-align: left;">Service Price Table</h2>

<table id="items-table">
  <thead>
    <tr>
      <th>Delete</th>
      <th>Note</th>
      <th>Price</th>
      <th>UOM</th>
      <th>Description</th>
      <th>S/N</th>
    </tr>
  </thead>
  <tbody>
    <!-- الصفوف ستُضاف هنا بواسطة JavaScript -->
  </tbody>
</table>

<!-- زر الإضافة -->
<button onclick="addRow()">➕ Add Item</button>

<!-- ✅ سكربت جافاسكربت - ضعه في أسفل الصفحة -->
<script>
  function addRow() {
    const table = document.getElementById("items-table").getElementsByTagName("tbody")[0];
    const rowCount = table.rows.length;
    const row = table.insertRow();

    row.innerHTML = `
      <td>
        <button class="delete-btn" onclick="deleteRow(this)">❌</button>
      </td>
      <td><input type="text" class="item-note" style="text-align: left;" /></td>
      <td><input type="number" class="item-price" style="text-align: left;" /></td>
      <td><input type="text" class="item-uom" style="text-align: left;" /></td>
      <td><input type="text" class="item-desc" style="text-align: left;" /></td>
      <td>${rowCount + 1}</td>
    `;
  }

  function deleteRow(btn) {
    const row = btn.closest("tr");
    row.remove();

    // إعادة ترقيم الصفوف
    const rows = document.querySelectorAll("#items-table tbody tr");
    rows.forEach((r, index) => {
      r.cells[5].textContent = index + 1; // العمود الأخير هو رقم الصف
    });
  }
</script>
<script>
  // جلب العملاء من localStorage وملء الدروب داون
  function populateClientDropdown() {
    const clients = JSON.parse(localStorage.getItem("customersList") || "[]");
    const clientSelect = document.getElementById("client");

    clients.forEach(client => {
      const option = document.createElement("option");
      option.value = client.id; // نخزن ID كـ value
      option.textContent = client.nameAr; // نعرض الاسم العربي
      clientSelect.appendChild(option);
    });
  }

  // عند اختيار عميل، نملأ باقي البيانات تلقائيًا في الحقول المخفية أو المتغيرات
  function fillClientInfo() {
    const clientId = document.getElementById("client").value;
    const clients = JSON.parse(localStorage.getItem("customersList") || "[]");
    const selectedClient = clients.find(c => c.id === clientId);
    
    if (selectedClient) {
      // هنا يتم ربط بيانات العميل بالمتغيرات في ملف الوورد
      window.selectedClientData = {
client_name_ar: window.selectedClientData.client_name_ar,
client_name_en: window.selectedClientData.client_name_en,
client_address_ar: window.selectedClientData.client_address_ar,
client_address_en: window.selectedClientData.client_address_en,
client_cr: window.selectedClientData.client_cr,
client_vat: window.selectedClientData.client_vat,
client_id: window.selectedClientData.client_id
      };
    }
  }


let clientsData = [];

async function loadClients() {
  try {
    const response = await fetch("https://agreement-generator-kfsp.onrender.com/customers.json");
    clientsData = await response.json();

    const dropdown = document.getElementById("client");
    dropdown.innerHTML = `<option value="">-- اختر عميل --</option>`; // Reset

    clientsData.forEach((client, index) => {
      const option = document.createElement("option");
      option.value = index;
      option.textContent = client.client_name_ar;
      dropdown.appendChild(option);
    });

  } catch (error) {
    console.error("❌ فشل تحميل العملاء:", error);
  }
}

function fillClientInfo() {
  const selectedIndex = document.getElementById("client").value;
  const infoDiv = document.getElementById("client-info");

  if (selectedIndex === "") {
    infoDiv.innerHTML = '<p>🔹 لم يتم اختيار عميل.</p>';
    window.selectedClientData = null;
    return;
  }

  const selectedClient = clientsData[selectedIndex];
  window.selectedClientData = selectedClient; // 🟡 سيتم استخدامه لاحقًا في إنشاء الاتفاقية

  infoDiv.innerHTML = `
    <p>📄 CR: ${selectedClient.client_cr}</p>
    <p>📍 Address (AR): ${selectedClient.client_address_ar}</p>
    <p>🌍 Address (EN): ${selectedClient.client_address_en}</p>
    <p>🧾 VAT: ${selectedClient.client_vat}</p>
  `;
}

// تحميل العملاء بمجرد تحميل الصفحة
window.addEventListener("DOMContentLoaded", loadClients);

  
  // استدعاء أولي لتعبئة القائمة عند تحميل الصفحة
  window.addEventListener("DOMContentLoaded", populateClientDropdown);
</script>

<script>
  async function loadCustomers() {
    try {
      const response = await fetch('./customers.json');
      const customers = await response.json();

      const clientSelect = document.getElementById("client");
      clientSelect.innerHTML = '<option value="">-- اختر العميل --</option>';

      customers.forEach((customer, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.textContent = customer.client_name_ar;
        clientSelect.appendChild(option);
      });

      // تخزين بيانات العملاء للرجوع لها لاحقًا
      window.customersData = customers;

    } catch (error) {
      console.error("فشل تحميل ملف العملاء:", error);
    }
  }

  function fillClientInfo() {
    const selectedIndex = document.getElementById("client").value;
    if (selectedIndex === "") return;

    const selectedCustomer = window.customersData[selectedIndex];
    window.selectedClientData = {
client_name_ar: window.selectedClientData.client_name_ar,
client_name_en: window.selectedClientData.client_name_en,
client_address_ar: window.selectedClientData.client_address_ar,
client_address_en: window.selectedClientData.client_address_en,
client_cr: window.selectedClientData.client_cr,
client_vat: window.selectedClientData.client_vat,
client_id: window.selectedClientData.client_id
      
    };
  }

  window.onload = loadCustomers;
</script>

<!-- مكان تقديم الخدمة -->
<div class="service-place-row">
  
  <div class="service-place-box">
    <label for="agreement_place_ar" style="display: block; text-align: left;">
      📍 Arabic Service Place
    </label>
    <textarea name="agreement_Place_ar" id="agreement_Place_ar" style="text-align: right;" dir="rtl"></textarea>
  </div>

  <div class="service-place-box">
    <label for="agreement_place_en" style="display: block; text-align: left;">
      📍 English Service Place
    </label>
    <textarea name="agreement_Place_en" id="agreement_Place_en" style="text-align: left;" dir="ltr"></textarea>
  </div>

</div>


<div class="payment-duration-row">
<!-- شروط الدفع والمدة في صف واحد - تصميم احترافي ومحاذاة لليسار -->
<div class="form-inline-group" style="justify-content: left;">
  <!-- شروط الدفع -->
  <div style="display: flex; align-items: center; gap: 10px;">
    <select id="credit-term" style="width: 150px;">
      <option>15 Days</option>
      <option>30 Days</option>
      <option>45 Days</option>
      <option>60 Days</option>
      <option>90 Days</option>
    </select>
        <label for="credit-term" style="margin: 0;">:Credit Terms</label>

  </div>

  <!-- المسافة بين المجموعتين -->
  <div style="width: 40px;"></div>

  <!-- المدة من وإلى -->
  <div style="display: flex; align-items: center; gap: 30px;">
    <input type="date" id="end-date" />
        <label for="end-date" style="margin: 0;">To</label>
         <input type="date" id="start-date" />
        <label for="start-date" style="margin: 0;">From</label>
        <label style="margin: 0;">:Agreement duration</label>

  </div>
</div>


    </div>

<h3 style="text-align: left;">Additional Terms</h3>

<div class="two-cols">
  <!-- Arabic Item  -->
  <div>
    <label style="text-align: left; display: block;">:Arabic Item </label>
    <textarea id="extra-ar" rows="2" dir="rtl" style="text-align: right;"></textarea>
  </div>

  <!-- English Item -->
  <div>
    <label style="text-align: left; display: block;">:English Item</label>
    <textarea id="extra-en" rows="2" dir="ltr" style="text-align: left;"></textarea>
  </div>
</div>

<button id="save-btn" type="button" onclick="saveAgreement(event)">
  💾 Save Agreement
</button>

<!-- ✅ أزرار التحميل (Word + PDF) -->
<div id="download-section" style="display: none; text-align: center; margin-top: 30px;">
<a id="download-link" href="#" class="download-btn word-btn" download style="margin-right: 15px;">
  <img src="https://upload.wikimedia.org/wikipedia/commons/1/19/Microsoft_Office_Word_%282019%E2%80%932025%29.svg"
       alt="Word"
       style="width: 24px; vertical-align: middle; margin-right: 8px;">
  Word Download (Word)
</a>

<a id="download-pdf-link" href="#" class="download-btn pdf-btn" download>
  <img src="https://upload.wikimedia.org/wikipedia/commons/8/87/PDF_file_icon.svg" alt="PDF" style="width: 24px; vertical-align: middle; margin-right: 8px;">
  PDF Download (PDF)
  </a>
</div>

<script>
const tbody = document.querySelector('#items-table tbody');

function fillClientInfo() {
  const selectedIndex = document.getElementById("client").value;
  const infoDiv = document.getElementById("client-info");

  if (selectedIndex === "") {
    infoDiv.innerHTML = '<p>🔹 الرجاء اختيار عميل.</p>';
    return;
  }

  const selectedCustomer = window.customersData[selectedIndex];
  window.selectedClientData = {
    client_name_ar: selectedCustomer.client_name_ar,
    client_name_en: selectedCustomer.client_name_en,
    client_address_ar: selectedCustomer.client_address_ar,
    client_address_en: selectedCustomer.client_address_en,
    client_cr: selectedCustomer.client_cr
  };

  infoDiv.innerHTML = `
    <p>📄 <strong>السجل التجاري:</strong> ${selectedCustomer.client_cr}</p>
    <p>📍 <strong>العنوان (عربي):</strong> ${selectedCustomer.client_address_ar}</p>
    <p>🌍 <strong>العنوان (إنجليزي):</strong> ${selectedCustomer.client_address_en}</p>
    <p>👤 <strong>الاسم (عربي):</strong> ${selectedCustomer.client_name_ar}</p>
    <p>🗣️ <strong>الاسم (إنجليزي):</strong> ${selectedCustomer.client_name_en}</p>
  `;
}
body: JSON.stringify({
  selectedCompany: 'Mamzar', // أو 'Tradix'
  agreement_date: "...",
  client_name: "...",
  // باقي البيانات...
})


function addItem() {
  const row = tbody.insertRow();
  row.innerHTML = `
    <td></td>
    <td><input type="text" /></td>
    <td><input type="text" /></td>
    <td><input type="number" /></td>
    <td><input type="text" /></td>
    <td><button onclick="removeRow(this)">❌</button></td>
  `;
  reorderRows();
}

function removeRow(btn) {
  btn.closest('tr').remove();
  reorderRows();
}

function reorderRows() {
  [...tbody.rows].forEach((row, index) => {
    row.cells[0].textContent = index + 1;
  });
}

<script>
let selectedCompany = "tradix"; // الافتراضي Tradix
let selectedTemplate = "agreement_templatev1.docx"; // ملف Tradix الافتراضي

const tradixBtn = document.getElementById("tradixBtn");
const mamzarBtn = document.getElementById("mamzarBtn");

// حالة افتراضية
document.body.classList.add("tradix-bg");

// عند الضغط على Tradix
tradixBtn.addEventListener("click", () => {
  selectedCompany = "tradix";
  selectedTemplate = "agreement_templatev1.docx";

  tradixBtn.classList.add("active-btn");
  mamzarBtn.classList.remove("active-btn");

  document.body.classList.remove("mamzar-bg");
  document.body.classList.add("tradix-bg");

  updateFieldColors("#ffffff", "#00cfff");
});

// عند الضغط على Mamzar
mamzarBtn.addEventListener("click", () => {
  selectedCompany = "mamzar";
  selectedTemplate = "agreement_template.docx";

  mamzarBtn.classList.add("active-btn");
  tradixBtn.classList.remove("active-btn");

  document.body.classList.remove("tradix-bg");
  document.body.classList.add("mamzar-bg");

  updateFieldColors("#fafff3", "#2ecc71");
});

function saveAgreement(e) {
  if (e) e.preventDefault();

  const items = [...document.querySelectorAll('#items-table tbody tr')].map(row => ({
    desc: row.cells[4].querySelector('input').value,
    uom: row.cells[3].querySelector('input').value,
    price: row.cells[2].querySelector('input').value,
    note: row.cells[1].querySelector('input').value,
  }));

  const data = {
    agreement_date: document.getElementById('agreement-date').value,
    client_name: document.getElementById('client').value,
    agreement_Place_ar: document.getElementById("agreement_Place_ar").value,
    agreement_Place_en: document.getElementById("agreement_Place_en").value,
    credit_term: document.getElementById('credit-term').value,
    start_date: document.getElementById('start-date').value,
    end_date: document.getElementById('end-date').value,
    items_table: items,
    extra_ar: document.getElementById('extra-ar').value,
    extra_en: document.getElementById('extra-en').value
  };

// تعديل طلب POST لإرسال البيانات إلى السيرفر الفعلي
fetch("https://agreement-generator-kfsp.onrender.com/generate", {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
})
  .then(res => {
    if (res.ok) {
      document.getElementById('save-btn').textContent = '✅ تم الحفظ';
      document.getElementById('save-btn').classList.add('save-success');
      document.getElementById('download-section').style.display = 'block';
      // ✅ تحديث روابط التحميل بناءً على الشركة
document.getElementById('download-link').href =
  `https://agreement-generator-kfsp.onrender.com/download?company=${selectedCompany}`;

document.getElementById('download-pdf-link').href =
  `https://agreement-generator-kfsp.onrender.com/download-pdf?company=${selectedCompany}`;

    } else {
      alert("❌ خطأ في الحفظ.");
    }
  })
  .catch(err => {
    alert("⚠️ لم يتم الاتصال بالسيرفر.");
    console.error(err);
  });
}
</script>
<script>
let selectedCompany = "tradix"; // الافتراضي Tradix
let selectedTemplate = "agreement_templatev1.docx"; // ملف Tradix الافتراضي

const tradixBtn = document.getElementById("tradixBtn");
const mamzarBtn = document.getElementById("mamzarBtn");

// حالة افتراضية
document.body.classList.add("tradix-bg");

// عند الضغط على Tradix
tradixBtn.addEventListener("click", () => {
  selectedCompany = "tradix";
  selectedTemplate = "agreement_templatev1.docx";

  // فعّل الزر
  tradixBtn.classList.add("active-btn");
  mamzarBtn.classList.remove("active-btn");

  // غير الخلفية
  document.body.classList.remove("mamzar-bg");
  document.body.classList.add("tradix-bg");

  // تنسيق الحقول
  updateFieldColors("#ffffff", "#00cfff");
});

// عند الضغط على Mamzar
mamzarBtn.addEventListener("click", () => {
  selectedCompany = "mamzar";
  selectedTemplate = "agreement_template.docx";

  mamzarBtn.classList.add("active-btn");
  tradixBtn.classList.remove("active-btn");

  document.body.classList.remove("tradix-bg");
  document.body.classList.add("mamzar-bg");

  updateFieldColors("#fafff3", "#2ecc71");
});


function saveAgreement(e) {
  if (e) e.preventDefault();

  // استخراج عناصر الجدول
  const items = [...document.querySelectorAll('#items-table tbody tr')].map(row => ({
    desc: row.cells[4].querySelector('input').value,
    uom: row.cells[3].querySelector('input').value,
    price: row.cells[2].querySelector('input').value,
    note: row.cells[1].querySelector('input').value,
  }));

  // بيانات الشركة حسب الاختيار
  let entity_name_ar, entity_name_en, entity_detail_ar, entity_detail_en;

  if (selectedCompany === "mamzar") {
    entity_name_ar = "مؤسسة ممزر للمقاولات العامة";
    entity_name_en = "Mamzar for General Contracting Est";
    entity_detail_ar = `مؤسسة ممزر للمقاولات العامة
سجل تجاري: 2050073487
العنوان: حي غرناطة ش طرفة بن العبد , الدمام , المملكة العربية السعودية`;
    entity_detail_en = `Mamzar for General Contracting Est
CR :2050073487
Adress: Ghernata Dist, Turfa bin Alabd St, Dammam, KSA`;
  } else {
    entity_name_ar = "شركة اس ترديكسسا";
    entity_name_en = "S TRADIXSA COMPANY";
    entity_detail_ar = `شركة اس ترديكسسا
تجاري عربي : 7052015091
العنوان: حي قرطبة , شارع طارق بن زياد , الخبر , المملكة العربية السعودية`;
    entity_detail_en = `S TRADIXSA COMPANY
CR: 7052015091
Adress: Al-Khubar Qurtuban Dist , Tariq bin Ziyad, King of Saudi Arabia`;
  }

  // استخراج بيانات العميل
  const clientIndex = document.getElementById('client').value;
  const selectedClientData = clientsData[parseInt(clientIndex)];

  if (!selectedClientData) {
    alert("⚠️ لم يتم اختيار عميل.");
    return;
  }

  // بناء البيانات المرسلة
  const data = {
    selectedCompany,
    selectedTemplate,
    entity_name_ar,
    entity_name_en,
    entity_detail_ar,
    entity_detail_en,
    agreement_date: document.getElementById('agreement-date').value,
    agreement_Place_ar: document.getElementById("agreement_Place_ar").value,
    agreement_Place_en: document.getElementById("agreement_Place_en").value,
    credit_term: document.getElementById('credit-term').value,
    start_date: document.getElementById('start-date').value,
    end_date: document.getElementById('end-date').value,
    items_table: items,
    extra_ar: document.getElementById('extra-ar').value,
    extra_en: document.getElementById('extra-en').value,

    // بيانات العميل
    client_name_ar: selectedClientData.client_name_ar,
    client_name_en: selectedClientData.client_name_en,
    client_address_ar: selectedClientData.client_address_ar,
    client_address_en: selectedClientData.client_address_en,
    client_cr: selectedClientData.client_cr,
    client_vat: selectedClientData.client_vat,
    client_id: selectedClientData.client_id
  };

  // إرسال البيانات إلى السيرفر
  fetch("https://agreement-generator-kfsp.onrender.com/generate", {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  })
  .then(res => {
    if (res.ok) {
      document.getElementById('save-btn').textContent = '✅ تم الحفظ';
      document.getElementById('save-btn').classList.add('save-success');
      document.getElementById('download-section').style.display = 'block';
      // ✅ تحديث روابط التحميل بناءً على الشركة
document.getElementById('download-link').href =
  `https://agreement-generator-kfsp.onrender.com/download?company=${selectedCompany}`;

document.getElementById('download-pdf-link').href =
  `https://agreement-generator-kfsp.onrender.com/download-pdf?company=${selectedCompany}`;

    } else {
      alert("❌ خطأ في الحفظ.");
    }
  })
  .catch(err => {
    alert("⚠️ لم يتم الاتصال بالسيرفر.");
    console.error(err);
  });
}
</script>
</body>
</html>

