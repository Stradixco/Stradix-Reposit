<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>إنشاء اتفاقية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">



  <!-- ✅ Header and sidebar -->
  <link rel="stylesheet" href="../background-header/Header-style.css" />
  <script src="../background-header/load-header.js" defer></script>
  <link rel="stylesheet" href="sidebar-style.css" />
  <script src="load-sidebar.js" defer></script>



  <style>
  .company-switcher {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
  }

  .company-btn {
    padding: 10px 20px;
    font-size: 16px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    border-radius: 8px;
    box-shadow: none;
    transition: all 0.3s ease-in-out;
  }

  .active-btn {
    box-shadow: 0 0 10px 3px rgba(0,0,0,0.3);
  }

  .mamzar-bg {
    background-color: #dff5d2 !important;
  }

  .tradix-bg {
    background-color: #d2e8f5 !important;
  }


    :root {
      --primary: #1e3a8a;
      --secondary: #0f172a;
      --accent: #22d3ee;
      --danger: #ef4444;
      --text: #f8fafc;
      --glass: rgba(255, 255, 255, 0.05);
    }

    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e3a8a, #0f172a);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      color: var(--text);
      display: flex;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .main {
      flex: 1;
      padding: 30px;
      margin-top: 80px;
      margin-right: 250px;
    }

    .glass-card {
      background: var(--glass);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 18px;
      padding: 35px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(18px);
      transition: 0.3s;
    }

    h2, h3 {
      color: #ffffff;
      margin-bottom: 25px;
      text-shadow: 1px 1px 3px #000;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 18px;
      color: #dbeafe;
    }

    input, select, textarea {
      width: 98%;
      padding: 14px;
      border: none;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.07);
      color: #e2e3f0;
      margin-top: 6px;
      backdrop-filter: blur(6px);
      box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.1);
      transition: 0.3s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 0 2px var(--accent);
    }
  /* حقل تاريخ الاتفاقية */
  #agreement-date {
    width: 150px;
    height: 15px;
    font-size: 16px;
  }
    /* حقل تاريخ البداية */
  #start-date {
    width: 150px;
    height: 15px;
    font-size: 16px;
  }

  /* حقل تاريخ النهاية */
  #end-date {
    width: 150px;
    height: 15px;
    font-size: 16px;
  }
 /* حقل Credit Term */
  #credit-term {
    width: 150px;
    height: 45px;
    font-size: 16px;
  }
  /* البند الإضافي عربي */
  #extra-ar {
    width: 450px;
    height: 200px;
  }

  /* البند الإضافي إنجليزي */
  #extra-en {
    width: 450px;
    height: 200px;
  }

    /* جدول البنود: حقل وصف الخدمة */

.item-desc {
  width: 300px;
  height: 20px;
  border-radius: 10px;
  padding: 8px;
}
  /* جدول البنود: حقل وحدة القياس */

.item-uom {
  width: 70px;
  height: 20px;
  border-radius: 10px;
  padding: 8px;
}
  /* جدول البنود: حقل السعر */

.item-price {
  width: 90px;
  height: 20px;
  border-radius: 10px;
  padding: 8px;
}
  /* جدول البنود: حقل الملاحظات */

.item-note {
  width: 200px;
  height: 30px;
  border-radius: 10px;
  padding: 8px;
}

/* ✅ تنسيق عام لكل الـ Dropdowns */
select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;

  background-color: #24335A; /* لون خلفية القائمة */
  color: #ffffff;
  padding: 12px 16px;
  border: 2px solid #00cfff;
  border-radius: 12px;
  font-size: 16px;
  font-weight: bold;
  width: 100%;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  transition: 0.3s ease-in-out;
  cursor: pointer;
  position: relative;
  z-index: 2;
}

/* ✅ تغيير السهم باستخدام خلفية SVG */
select:after {
  content: "▼";
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}

/* ✅ عند الفوكس */
select:focus {
  outline: none;
  border-color: #66e0ff;
  box-shadow: 0 0 10px #00cfff;
}

/* ✅ تخصيص الـ option داخل القائمة */
select option {
  background-color: #192d45;
  color: #ffffff;
  padding: 10px;
  border-bottom: 1px solid #333;
  font-weight: 500;
}

/* ✅ تخصيص شريط التمرير للقائمة */
select::-webkit-scrollbar {
  width: 8px;
}

select::-webkit-scrollbar-thumb {
  background: #00cfff;
  border-radius: 10px;
}

select::-webkit-scrollbar-track {
  background: #1a1a2e;
}

  /* جدول البنود: زر الحذف */

.delete-btn {
  background: linear-gradient(145deg, #1e1e2f, #232342);
  color: red;
  font-size: 20px;
  font-weight: bold;
  text-align: center;
  border: none;
  border-radius: 12px;
  width: 40px;
  height: 40px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 8px #f4a3a366;
  transition: transform 0.2s, box-shadow 0.2s;
}

.delete-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 10px #fcf9f999;
}

.delete-btn:hover {
  background-color: #e60000;
}

    button {
      padding: 14px 28px;
      border: none;
      border-radius: 16px;
      background: linear-gradient(135deg, #1e3a8a, #2563eb);
      color: white;
      font-size: 16px;
      font-weight: bold;
      margin-top: 25px;
      cursor: pointer;
      transition: 0.3s ease;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
    }

    button:hover {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
    }

    .save-success {
      background: linear-gradient(135deg, #059669, #10b981) !important;
    }

    .two-cols {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .two-cols > div {
      flex: 1;
    }

    table {
      width: 100%;
      margin-top: 18px;
      border-collapse: collapse;
      border-radius: 12px;
      overflow: hidden;
    }

    th, td {
      padding: 14px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
      background-color: rgba(255, 255, 255, 0.03);
      color: #e2e8f0;
    }

    th {
      background-color: var(--primary);
      color: white;
    }

    .row-actions button {
      background-color: var(--danger);
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }

    .download-btn {
      display: inline-flex;
      align-items: center;
      margin: 10px;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: bold;
      color: white;
      border-radius: 12px;
      text-decoration: none;
      gap: 8px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }

    .word-btn {
      background-color: #2b579a;
    }

    .word-btn:hover {
      background-color: #1e3a8a;
    }

    .pdf-btn {
      background-color: #b91c1c;
    }

    .pdf-btn:hover {
      background-color: #7f1d1d;
    }

    #download-section {
      text-align: center;
      margin-top: 30px;
      display: none;
    }

    #client-info {
      margin-top: 12px;
      font-size: 14px;
      color: #cbd5e1;
    }
    

    /* حقل مكان تقديم الخدمة  */
    .service-place-row {
  display: flex;
  justify-content: space-between; /* توزع الحقول */
  gap: 30px; /* المسافة بين الحقول */
  margin-bottom: 25px; /* المسافة تحت الصف */
}

.service-place-box {
  flex: 1; /* كل واحد ياخد نصف العرض */
  display: flex;
  flex-direction: column;
}

.service-place-box label {
  font-weight: bold;
  margin-bottom: 5px;
  text-align: right;
  color: #ffffffcc;
}

.service-place-box textarea {
  width: 95%;
  height: 70px;
  padding: 12px;
  font-size: 16px;
  background: rgba(255, 255, 255, 0.07);
  border-radius: 15px;
}
/* ✅ تقليل المسافات الرأسية بين الحقول */
label {
  margin-top: 5px !important;  /* بدل 18px */
  margin-bottom: 3px !important;
}

input, select, textarea {
  margin-bottom: 3px !important;  /* تقليل المسافة بعد الحقل */
}
/* لعرض العنوان والحقل في سطر واحد */
.form-inline-group {
  display: flex;
  align-items: center;
  gap: 10px; /* مسافة بين العنوان والحقل */
  margin-bottom: 15px; /* مسافة بين الصفوف */
}

/* تنسيق إضافي لضبط حجم الحقل */
.form-inline-group input[type="date"] {
  width: 250px;
}

h2 {
  margin-bottom: 0px; /* تقليل المسافة تحت عنوان جدول الاسعار */
}

#items-table {
  margin-top: 0; /* إزالة أي مسافة علوية لجدول الاسعار */
}

.payment-duration-row {
  display: flex;
  align-items: center;
  gap: 40px;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

/* شروط الدفع */
.credit-term-group {
  display: flex;
  flex-direction: column;
  min-width: 180px;
}

/* المدة */
.duration-inline-group {
  display: flex;
  flex-direction: column;
}

.duration-inline-inputs {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 5px;
}

.duration-inline-inputs label {
  margin: 0 5px;
}

/* ✨ تفعيل الزر الحالي */
.company-btn.active-btn {
  box-shadow: 0 0 12px 4px rgba(255, 255, 255, 0.6);
  transform: scale(1.05);
}

/* ✨ ألوان خلفيات الصفحات */
body.tradix-bg {
  background: linear-gradient(135deg, #0f172a, #1e3a8a, #0f172a);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
}

body.mamzar-bg {
  background: linear-gradient(135deg, #0f3d1e, #215d3a, #0f3d1e);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
}

/* تصميم عام لزراير اختيار الشركة */

  /* تجاوز التصميم العام للأزرار داخل الزرارين فقط */
  #tradixBtn {
    background: hsl(214, 65%, 25%) !important;
    color: white !important;
  }

  #mamzarBtn {
    background: oklab(53.205999999999996% -0.14215 0.10958) !important;
    color: white !important;
  }

  .company-btn.active-btn {
    box-shadow: 0 0 12px 4px rgba(255, 255, 255, 0.6);
    transform: scale(1.05);
  }

  </style>
</head>
<body>


  
  <div id="header"></div>
  <div id="sidebar-container"></div>

  <div class="main">
    <div class="glass-card">
    <h2 style="text-align: center;">📝 Service Agreement Creation</h2>


      <div class="company-switcher">
        <button id="mamzarBtn" class="company-btn">Mamzar</button>
        <button id="tradixBtn" class="company-btn active-btn">Tradix</button>
      </div>

      <label for="client" style="margin-top: 25px;">: اختر العميل</label>
      <select id="client" onchange="fillClientInfo()">
        <option value="">-- اختر عميل --</option>
      </select>
      <div id="client-info" style="margin-top: 10px; font-weight: bold;"></div>

      <label for="agreement-date">تاريخ الاتفاقية:</label>
      <input type="date" id="agreement-date" />

      <h3>جدول البنود</h3>
      <table id="items-table">
        <thead>
          <tr>
            <th>حذف</th>
            <th>ملاحظات</th>
            <th>السعر</th>
            <th>الوحدة</th>
            <th>الوصف</th>
            <th>رقم</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button onclick="addRow()">➕ إضافة بند</button>

      <h3>مكان تقديم الخدمة</h3>
      <label>بالعربي:</label>
      <textarea id="agreement_Place_ar" dir="rtl"></textarea>

      <label>بالإنجليزي:</label>
      <textarea id="agreement_Place_en" dir="ltr"></textarea>

      <h3>شروط الدفع</h3>
      <label for="credit-term">Credit Term:</label>
      <select id="credit-term">
        <option>15 Days</option>
        <option>30 Days</option>
        <option>45 Days</option>
        <option>60 Days</option>
      </select>

      <h3>مدة الاتفاقية</h3>
      <label>من:</label>
      <input type="date" id="start-date" />
      <label>إلى:</label>
      <input type="date" id="end-date" />

      <h3>شروط إضافية</h3>
      <label>بالعربية:</label>
      <textarea id="extra-ar" dir="rtl"></textarea>

      <label>بالإنجليزية:</label>
      <textarea id="extra-en" dir="ltr"></textarea>

      <button id="save-btn" onclick="saveAgreement(event)">💾 حفظ الاتفاقية</button>

      <div id="download-section">
        <a id="download-link" class="download-btn word-btn" download>📄 تحميل Word</a>
        <a id="download-pdf-link" class="download-btn pdf-btn" download>📄 تحميل PDF</a>
      </div>
    </div>
  </div>
<script>
let selectedCompany = "tradix"; // القيمة الابتدائية
let selectedTemplate = "agreement_templatev1.docx";
let clientsData = [];

document.addEventListener("DOMContentLoaded", () => {
  // ✅ تحميل العملاء من السيرفر
  fetch("https://agreement-generator-kfsp.onrender.com/customers.json")
    .then(res => res.json())
    .then(data => {
      clientsData = data;
      const clientSelect = document.getElementById("client");
      clientSelect.innerHTML = `<option value="">-- اختر عميل --</option>`;
      data.forEach((client, index) => {
        const option = document.createElement("option");
        option.value = index;
        option.textContent = client.client_name_ar;
        clientSelect.appendChild(option);
      });
    });

  // ✅ زر تغيير إلى Tradix
  document.getElementById("tradixBtn").addEventListener("click", () => {
    selectedCompany = "tradix";
    selectedTemplate = "agreement_templatev1.docx";
    toggleCompanyUI("tradix");
  });

  // ✅ زر تغيير إلى Mamzar
  document.getElementById("mamzarBtn").addEventListener("click", () => {
    selectedCompany = "mamzar";
    selectedTemplate = "agreement_template.docx";
    toggleCompanyUI("mamzar");
  });
});

// ✅ تغيير مظهر الصفحة حسب الشركة
function toggleCompanyUI(company) {
  document.getElementById("tradixBtn").classList.remove("active-btn");
  document.getElementById("mamzarBtn").classList.remove("active-btn");

  if (company === "tradix") {
    document.getElementById("tradixBtn").classList.add("active-btn");
    document.body.classList.remove("mamzar-bg");
    document.body.classList.add("tradix-bg");
  } else {
    document.getElementById("mamzarBtn").classList.add("active-btn");
    document.body.classList.remove("tradix-bg");
    document.body.classList.add("mamzar-bg");
  }
}

// ✅ عند اختيار عميل
function fillClientInfo() {
  const index = document.getElementById("client").value;
  const infoDiv = document.getElementById("client-info");

  if (index === "") {
    infoDiv.innerHTML = "<p>🔹 لم يتم اختيار عميل.</p>";
    window.selectedClientData = null;
    return;
  }

  const client = clientsData[index];
  window.selectedClientData = client;

  infoDiv.innerHTML = `
    <p>📄 السجل التجاري: ${client.client_cr}</p>
    <p>📍 العنوان (عربي): ${client.client_address_ar}</p>
    <p>🌍 العنوان (إنجليزي): ${client.client_address_en}</p>
    <p>👤 الاسم (عربي): ${client.client_name_ar}</p>
    <p>🗣️ الاسم (إنجليزي): ${client.client_name_en}</p>
  `;
}

// ✅ إضافة صف بند جديد
function addRow() {
  const tbody = document.querySelector('#items-table tbody');
  const rowCount = tbody.rows.length;
  const row = tbody.insertRow();

  row.innerHTML = `
    <td><button class="delete-btn" onclick="deleteRow(this)">❌</button></td>
    <td><input type="text" class="item-note" /></td>
    <td><input type="number" class="item-price" /></td>
    <td><input type="text" class="item-uom" /></td>
    <td><input type="text" class="item-desc" /></td>
    <td>${rowCount + 1}</td>
  `;
}

// ✅ حذف صف
function deleteRow(btn) {
  btn.closest("tr").remove();
  reorderRows();
}

// ✅ إعادة ترقيم الصفوف
function reorderRows() {
  const rows = document.querySelectorAll("#items-table tbody tr");
  rows.forEach((r, i) => {
    r.cells[5].textContent = i + 1;
  });
}

// ✅ حفظ الاتفاقية
function saveAgreement(e) {
  if (e) e.preventDefault();

  const items = [...document.querySelectorAll('#items-table tbody tr')].map(row => ({
    desc: row.cells[4].querySelector('input').value,
    uom: row.cells[3].querySelector('input').value,
    price: row.cells[2].querySelector('input').value,
    note: row.cells[1].querySelector('input').value,
  }));

  const clientIndex = document.getElementById('client').value;
  const client = clientsData[clientIndex];

  if (!client) {
    alert("⚠️ اختر عميلًا صالحًا.");
    return;
  }

  const data = {
    selectedCompany,
    selectedTemplate,
    agreement_date: document.getElementById('agreement-date').value,
    agreement_Place_ar: document.getElementById("agreement_Place_ar").value,
    agreement_Place_en: document.getElementById("agreement_Place_en").value,
    credit_term: document.getElementById('credit-term').value,
    start_date: document.getElementById('start-date').value,
    end_date: document.getElementById('end-date').value,
    items_table: items,
    extra_ar: document.getElementById('extra-ar').value,
    extra_en: document.getElementById('extra-en').value,

    client_name_ar: client.client_name_ar,
    client_name_en: client.client_name_en,
    client_address_ar: client.client_address_ar,
    client_address_en: client.client_address_en,
    client_cr: client.client_cr,
    client_vat: client.client_vat,
    client_id: client.client_id
  };

  fetch("https://agreement-generator-kfsp.onrender.com/generate", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(data)
  })
  .then(res => {
    if (res.ok) {
      document.getElementById("save-btn").textContent = "✅ تم الحفظ";
      document.getElementById("save-btn").classList.add("save-success");
      document.getElementById("download-section").style.display = "block";

      document.getElementById("download-link").href = `https://agreement-generator-kfsp.onrender.com/download?company=${selectedCompany}`;
      document.getElementById("download-pdf-link").href = `https://agreement-generator-kfsp.onrender.com/download-pdf?company=${selectedCompany}`;
    } else {
      alert("❌ فشل الحفظ.");
    }
  })
  .catch(err => {
    console.error(err);
    alert("⚠️ تعذر الاتصال بالخادم.");
  });
}
</script>
